groups:
  # ===== INFRASTRUCTURE ALERTS =====
  - name: infrastructure
    interval: 30s
    rules:
      # Host system down - critical infrastructure failure
      - alert: HostDown
        expr: up{job="node-exporter"} == 0
        for: 3m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Host system is down"
          description: "Node exporter has been down for more than 3 minutes. Host: {{ $labels.instance }}"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#host-down"

      # Critical CPU usage - immediate attention required
      - alert: CriticalCPUUsage
        expr: homeserver:system_cpu_usage_percent > 95
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "Critical CPU usage detected"
          description: "CPU usage is above 95% for more than 2 minutes. Current usage: {{ $value }}%"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#high-cpu"

      # High CPU usage - performance degradation warning
      - alert: HighCPUUsage
        expr: homeserver:system_cpu_usage_percent > 80
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 10 minutes. Current usage: {{ $value }}%"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#high-cpu"

      # Critical memory usage - immediate attention required
      - alert: CriticalMemoryUsage
        expr: homeserver:system_memory_usage_percent > 95
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "Critical memory usage detected"
          description: "Memory usage is above 95% for more than 2 minutes. Current usage: {{ $value }}%"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#high-memory"

      # High memory usage - potential resource exhaustion
      - alert: HighMemoryUsage
        expr: homeserver:system_memory_usage_percent > 85
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% for more than 10 minutes. Current usage: {{ $value }}%"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#high-memory"

      # Disk space critical - immediate action required
      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 90
        for: 2m
        labels:
          severity: critical
          category: storage
        annotations:
          summary: "Disk space critically low"
          description: "Disk usage is above 90% on {{ $labels.mountpoint }}. Current usage: {{ $value }}%"
          runbook_url: "https://docs.yourdomain.com/runbooks/disk-space"

      # Disk space warning - preemptive alert
      - alert: DiskSpaceWarning
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 75
        for: 5m
        labels:
          severity: warning
          category: storage
        annotations:
          summary: "Disk space running low"
          description: "Disk usage is above 75% on {{ $labels.mountpoint }}. Current usage: {{ $value }}%"

      # Docker daemon health - container orchestration failure
      - alert: DockerDaemonDown
        expr: up{job="docker"} == 0
        for: 2m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Docker daemon is down"
          description: "Docker daemon has been unreachable for more than 2 minutes"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#docker-daemon-down"

      # Network latency high - connectivity issues
      - alert: HighNetworkLatency
        expr: probe_duration_seconds{job="blackbox-icmp"} > 0.1
        for: 5m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "High network latency detected"
          description: "Network latency to {{ $labels.instance }} is {{ $value }}s"

      # System load high - performance bottleneck
      - alert: HighSystemLoad
        expr: homeserver:system_load5 > 4
        for: 15m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High system load detected"
          description: "5-minute load average is {{ $value }}, indicating system stress"

      # I/O wait high - storage bottleneck
      - alert: HighIOWait
        expr: rate(node_cpu_seconds_total{mode="iowait"}[5m]) * 100 > 20
        for: 10m
        labels:
          severity: warning
          category: storage
        annotations:
          summary: "High I/O wait detected"
          description: "System spending {{ $value }}% time waiting for I/O operations"

  # ===== CONTAINER ALERTS =====
  - name: containers
    interval: 30s
    rules:
      # Container down - service availability issue
      - alert: ContainerDown
        expr: absent(container_last_seen{name!=""}) or (time() - container_last_seen{name!=""}) > 60
        for: 1m
        labels:
          severity: critical
          category: service
        annotations:
          summary: "Container is down"
          description: "Container {{ $labels.name }} has been down for more than 1 minute"
          runbook_url: "https://docs.yourdomain.com/runbooks/container-down"

      # High container memory usage - resource constraint warning
      - alert: ContainerHighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Container high memory usage"
          description: "Container {{ $labels.name }} is using {{ $value }}% of its memory limit"

      # Container restarting frequently - stability issue
      - alert: ContainerRestartingFrequently
        expr: rate(container_start_time_seconds[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: stability
        annotations:
          summary: "Container restarting frequently"
          description: "Container {{ $labels.name }} has restarted more than 5 times in 15 minutes"

  # ===== DATABASE ALERTS =====
  - name: database
    interval: 30s
    rules:
      # MariaDB down - critical data service failure
      - alert: MariaDBDown
        expr: up{job="mariadb"} == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "MariaDB is down"
          description: "MariaDB database has been down for more than 1 minute"
          runbook_url: "https://docs.yourdomain.com/runbooks/mariadb-down"

      # High database connections - potential resource exhaustion
      - alert: MariaDBHighConnections
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MariaDB high connection usage"
          description: "MariaDB is using {{ $value }}% of available connections"

      # Redis down - session/cache service failure
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Redis is down"
          description: "Redis cache service has been down for more than 1 minute"

      # Redis high memory usage - cache eviction risk
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis high memory usage"
          description: "Redis is using {{ $value }}% of allocated memory"

  # ===== WEB SERVICES ALERTS =====
  - name: web_services
    interval: 30s
    rules:
      # HTTP service down - external access failure
      - alert: HTTPServiceDown
        expr: probe_success{job="blackbox-http"} == 0
        for: 2m
        labels:
          severity: critical
          category: web_service
        annotations:
          summary: "HTTP service unreachable"
          description: "Service {{ $labels.instance }} is not responding to HTTP checks"
          runbook_url: "https://docs.yourdomain.com/runbooks/http-service-down"

      # SSL certificate expiring soon - security maintenance needed
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7  # 7 days
        for: 1h
        labels:
          severity: warning
          category: security
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate for {{ $labels.instance }} expires in {{ $value }} seconds"

      # High HTTP response time - performance issue
      - alert: HighHTTPResponseTime
        expr: probe_duration_seconds{job="blackbox-http"} > 5
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High HTTP response time"
          description: "HTTP response time for {{ $labels.instance }} is {{ $value }} seconds"

  # ===== APPLICATION SPECIFIC ALERTS =====
  - name: applications
    interval: 60s
    rules:
      # Plex down - media service failure
      - alert: PlexDown
        expr: up{job="plex"} == 0
        for: 2m
        labels:
          severity: warning
          category: media
        annotations:
          summary: "Plex Media Server is down"
          description: "Plex has been unreachable for more than 2 minutes"

      # TeamSpeak down - voice service failure
      - alert: TeamSpeakDown
        expr: up{job="teamspeak"} == 0
        for: 1m
        labels:
          severity: warning
          category: gaming
        annotations:
          summary: "TeamSpeak server is down"
          description: "TeamSpeak server has been unreachable for more than 1 minute"

      # CS2 server down - game service failure
      - alert: CS2ServerDown
        expr: up{job="cs2-server"} == 0
        for: 2m
        labels:
          severity: warning
          category: gaming
        annotations:
          summary: "CS2 server is down"
          description: "Counter-Strike 2 server has been unreachable for more than 2 minutes"

      # qBittorrent down - download service failure
      - alert: QBittorrentDown
        expr: up{job="qbittorrent"} == 0
        for: 2m
        labels:
          severity: warning
          category: media
        annotations:
          summary: "qBittorrent is down"
          description: "qBittorrent service has been unreachable for more than 2 minutes"

  # ===== MONITORING ALERTS =====
  - name: monitoring
    interval: 60s
    rules:
      # Prometheus targets down - monitoring blind spots
      - alert: PrometheusTargetDown
        expr: up == 0
        for: 5m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Prometheus target down"
          description: "Prometheus target {{ $labels.job }}/{{ $labels.instance }} has been down for 5 minutes"

      # High scrape duration - monitoring performance issue
      - alert: PrometheusScrapeSlowdown
        expr: prometheus_target_interval_length_seconds{quantile="0.9"} > 60
        for: 5m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Prometheus scrape slowdown"
          description: "Prometheus scrape duration is high: {{ $value }} seconds"

      # Prometheus storage usage - monitoring data retention risk
      - alert: PrometheusStorageUsageHigh
        expr: prometheus_tsdb_symbol_table_size_bytes / (1024*1024*1024) > 8  # 8GB
        for: 10m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Prometheus storage usage high"
          description: "Prometheus storage is using {{ $value }}GB"

  # ===== GITHUB RUNNER ALERTS =====
  - name: github-runner
    interval: 60s
    rules:
      # GitHub Runner down - CI/CD pipeline unavailable
      - alert: GitHubRunnerDown
        expr: up{job="github-runner"} == 0
        for: 2m
        labels:
          severity: warning
          category: cicd
        annotations:
          summary: "GitHub Actions runner is down"
          description: "Self-hosted GitHub runner has been down for more than 2 minutes"
          runbook_url: "https://docs.yourdomain.com/runbooks/github-runner-down"

      # GitHub Runner high CPU usage
      - alert: GitHubRunnerHighCPU
        expr: rate(container_cpu_usage_seconds_total{name="github-runner"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          category: cicd
        annotations:
          summary: "GitHub runner high CPU usage"
          description: "GitHub runner is using {{ $value }}% CPU for more than 10 minutes"

      # GitHub Runner high memory usage
      - alert: GitHubRunnerHighMemory
        expr: (container_memory_usage_bytes{name="github-runner"} / container_spec_memory_limit_bytes{name="github-runner"}) * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: cicd
        annotations:
          summary: "GitHub runner high memory usage"
          description: "GitHub runner is using {{ $value }}% of allocated memory"

      # GitHub Runner storage usage high
      - alert: GitHubRunnerStorageFull
        expr: node_filesystem_avail_bytes{mountpoint=~".*runner.*"} / node_filesystem_size_bytes{mountpoint=~".*runner.*"} * 100 < 20
        for: 5m
        labels:
          severity: warning
          category: storage
        annotations:
          summary: "GitHub runner storage running low"
          description: "GitHub runner storage has less than 20% available space"

      # GitHub Runner cache service down
      - alert: GitHubRunnerCacheDown
        expr: up{job="runner-cache"} == 0
        for: 5m
        labels:
          severity: info
          category: cicd
        annotations:
          summary: "GitHub runner cache service down"
          description: "Runner cache service has been down for 5 minutes, builds may be slower"

      # Long running jobs (over 2 hours)
      - alert: GitHubRunnerLongJob
        expr: time() - container_start_time_seconds{name=~".*runner.*"} > 7200
        for: 1m
        labels:
          severity: info
          category: cicd
        annotations:
          summary: "GitHub runner job running for over 2 hours"
          description: "A GitHub Actions job has been running for more than 2 hours"

  # ===== SECURITY & BACKUP ALERTS =====
  - name: security_backup
    interval: 300s  # Check every 5 minutes
    rules:
      # Backup job failure - data protection at risk
      - alert: BackupJobFailed
        expr: up{job="backup"} == 0
        for: 24h
        labels:
          severity: critical
          category: backup
        annotations:
          summary: "Backup job has failed"
          description: "No successful backup detected in the last 24 hours"
          runbook_url: "https://github.com/somatczk/romulus/wiki/Runbooks#backup-failure"

      # Suspicious network activity - potential security threat
      - alert: UnusualNetworkTraffic
        expr: |
          (
            sum(rate(node_network_receive_bytes_total[5m])) by (instance) > 100000000 or
            sum(rate(node_network_transmit_bytes_total[5m])) by (instance) > 100000000
          )
        for: 15m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Unusual network traffic detected"
          description: "High network traffic (>100MB/s) detected for 15+ minutes on {{ $labels.instance }}"

      # Failed login attempts spike - brute force attack
      - alert: HighFailedLoginAttempts
        expr: |
          increase(node_systemd_unit_state{name="ssh.service",state="failed"}[1h]) > 10
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "High number of failed SSH login attempts"
          description: "More than 10 failed SSH login attempts in the last hour"

      # Container escape detection - security breach attempt
      - alert: ContainerPrivilegeEscalation
        expr: |
          container_processes{name!=""} > container_spec_memory_limit_bytes{name!=""} / 1048576
        for: 2m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Potential container privilege escalation detected"
          description: "Container {{ $labels.name }} may be attempting privilege escalation"